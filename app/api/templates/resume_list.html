<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume List</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        label { margin-right: 10px; }
        select { margin-bottom: 20px; }
        #resumes ul { list-style-type: none; padding: 0; }
        #resumes li { background: #f9f9f9; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; position: relative; display: flex; align-items: flex-start; justify-content: space-between; }
        #resumes li a { text-decoration: none; color: #007BFF; }
        .resume-content { white-space: pre-wrap; line-height: 1.5; flex-grow: 1; }
        .icon-container { display: flex; flex-direction: column; align-items: center; }
        .icon-container div { margin: 5px 0; }
        .delete-btn, .view-btn, .link-btn, .edit-btn, .updated-indicator { background: none; border: none; cursor: pointer; }
        .delete-btn { color: #FF0000; }
        .view-btn { color: #007BFF; }
        .link-btn { color: #28A745; }
        .edit-btn { color: #FFA500; }
        .updated-indicator { color: #FFD700; font-size: 1.5em; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgb(0,0,0); background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Resume List</h1>
    <form action="/resume_list/" method="GET">
        <label for="job">Select Job:</label>
        <select id="job" name="job_id" onchange="this.form.submit()">
            <option value="">--Select Job--</option>
            {% for job in jobs %}
            <option value="{{ job._id }}" {% if selected_job and selected_job._id == job._id %}selected{% endif %}>
                {{ job.job_number }} - {{ job.company_name }}
            </option>
            {% endfor %}
        </select>
    </form>
    <div id="resumes">
        {% if selected_job %}
        <h2>Resumes for Job {{ selected_job.job_number }} - {{ selected_job.company_name }}</h2>
        <ul>
            {% for resume in resumes %}
            <li>
                <div class="resume-content">{{ resume.full_text_resume }}</div>
                <div class="icon-container">
                    {% if resume.is_extracted_updated %}
                    <div class="updated-indicator" title="Updated">&#9733;</div>
                    {% endif %}
                    <div>
                        <button class="edit-btn" onclick="editResume('{{ resume._id }}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div>
                        <button class="link-btn" onclick="viewResumeLink('{{ resume._id }}')" title="View Link">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                    <div>
                        <button class="view-btn" onclick="viewResume('{{ resume._id }}')" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div>
                        <form action="/resume_list/delete_resume/{{ resume._id }}" method="POST" style="display:inline;">
                            <input type="hidden" name="job_id" value="{{ selected_job._id }}">
                            <button type="submit" class="delete-btn" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div id="resumeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <pre id="resumeText" class="resume-content"></pre>
        </div>
    </div>

    <div id="linkModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <pre id="resumeLink" class="resume-content"></pre>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Edit Resume</h3>
            <form id="editForm">
                <textarea id="editResumeText" rows="10" cols="80"></textarea>
                <br>
                <button type="button" onclick="confirmEdit()">Save</button>
            </form>
        </div>
    </div>

    <script>
        let currentResumeId = null;

        function viewResume(resumeId) {
            fetch(`/resume_list/view_resume/${resumeId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.resume_text) {
                        document.getElementById('resumeText').innerText = JSON.stringify(data.resume_text, null, 2);
                        document.getElementById('resumeModal').style.display = "block";
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
        }

        function viewResumeLink(resumeId) {
            fetch(`/resume_list/view_resume_link/${resumeId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.resume_link) {
                        document.getElementById('resumeLink').innerText = data.resume_link;
                        document.getElementById('linkModal').style.display = "block";
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
        }

        function editResume(resumeId) {
            currentResumeId = resumeId;
            fetch(`/resume_list/view_resume/${resumeId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.resume_text) {
                        document.getElementById('editResumeText').value = JSON.stringify(data.resume_text, null, 2);
                        document.getElementById('editModal').style.display = "block";
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
        }

        function confirmEdit() {
            if (confirm("Do you want to save the changes?")) {
                saveEdit();
            }
        }

        function saveEdit() {
            const editedText = document.getElementById('editResumeText').value;
            fetch(`/resume_list/edit_resume/${currentResumeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ extract_resume: editedText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    document.getElementById('editModal').style.display = "none";
                    location.reload();  // Refresh the page to show the updated indicator
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }

        document.querySelectorAll('.close').forEach(closeButton => {
            closeButton.onclick = function() {
                closeButton.closest('.modal').style.display = "none";
            }
        });

        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            });
        }
    </script>
</body>
</html>
